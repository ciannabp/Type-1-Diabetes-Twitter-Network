---
title: "t1d_lda_analysis"
author: "Cianna Bedford-Petersen"
date: "last knitted:`r Sys.time()`"
output: 
  html_document:
      df_print: paged
      toc_float: true 
      code_folding: hide
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}

library(tidyverse)
library(rio)
library(here)
library(topicmodels)
library(ldatuning)
library(future)
library(tictoc)
library(furrr)
library(reshape2)
library(RColorBrewer)
library(wordcloud)
library(tidytext)



knitr::opts_chunk$set(cache = TRUE, warning = FALSE, message = FALSE)
```

# Import cleaned and unnested tweets 

```{r}

t1d_tidy_tweets <- import(here("data_2020-01-03/t1d_tidy_tweets.Rdata"))

```

# LDA Analysis 

```{r lda}

# count how many times a tweet used each word
data(stop_words)

word_counts_tweet <- t1d_tidy_tweets %>%
  anti_join(stop_words) %>%
  count(status_id, word, sort = TRUE) %>%
  ungroup()

# make dataframe into a document term matrix
tweets_dtm <- word_counts_tweet %>%
  cast_dtm(status_id, word, n)
tweets_dtm

# determine perplexity 
n_topics <- c(2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30)

# cache the models and only estimate if they don't already exist
if (file.exists(here("t1d_tweets_compare.Rdata"))) {
  load(file = here("t1d_tweets_compare.Rdata"))
} else {
  plan(multiprocess)

  tic()
 t1d_tweets_compare <- n_topics %>%
    future_map(LDA, x = tweets_dtm, control = list(seed = 102219))
  toc()
  save(tweets_dtm, t1d_tweets_compare, file = here("t1d_tweets_compare.Rdata"))
}

# plot perplexity for each model
plot <- tibble(k = n_topics,
       perplex = map_dbl(t1d_tweets_compare, perplexity)) %>%
  ggplot(aes(k, perplex)) +
  geom_point() +
  geom_line() +
  labs(title = "Evaluating LDA topic models",
       subtitle = "Optimal number of topics (smaller is better)",
       x = "Number of topics",
       y = "Perplexity")
plot






```

# Run the Final LDA models
```{r 7}

#make the final model
t1d_lda7 <- LDA(tweets_dtm, k = 7, control = list(seed = 2320))
t1d_lda7

#extract the per-topic-per-word probabilities
t1d_topics7 <- tidy(t1d_lda7, matrix = "beta") %>% 
  filter(term != "t1d", term !="t1dlookslikeme", term !="brokenpancreas", term !="type1kid", term 
         !="typeonetypenone", term !="diabadass",term !="type1warrior", term !="beyondtype1", term 
         !="insulindependent", term !="typeonestrong", term !="dexcom", term !="MyFreeStyleCanada", 
         term !="GBdoc", term !="insulin4All", term !="diabetes", term !="#diabetes", term !="#t1d", 
         term !="de", term !="la", term !="#type1diabetes",term !="#insulin4all", term !="en", term 
         !="te", term !="el")
t1d_topics7

#pull top terms and visualize
t1d_top_terms7 <- t1d_topics7 %>%
  group_by(topic) %>%
  top_n(7, beta) %>%
  ungroup() %>%
  arrange(topic, -beta)

t1d_top_terms7 %>%
  mutate(term = reorder(term, beta)) %>%
  ggplot(aes(term, beta, fill = factor(topic))) +
  geom_col(show.legend = FALSE) +
  facet_wrap(~ topic, scales = "free") +
  coord_flip()

#wordcloud for most characteristic word in each topic
topics_beta <- tidy(t1d_lda7, matrix = "beta")

topics_beta %>%
  filter(term != "t1d", term !="t1dlookslikeme", term !="brokenpancreas", term !="type1kid", term 
         !="typeonetypenone", term !="diabadass",term !="type1warrior", term !="beyondtype1", term 
         !="insulindependent", term !="typeonestrong", term !="dexcom", term !="MyFreeStyleCanada", 
         term !="GBdoc", term !="insulin4All", term !="diabetes", term !="#diabetes", term !="#t1d", 
         term !="de", term !="la", term !="#type1diabetes",term !="#insulin4all", term !="en", term 
         !="te", term !="el") %>% 
  group_by(term) %>%
  top_n(1, beta) %>%
  group_by(topic) %>%
  top_n(50, beta) %>%
  acast(term ~ topic, value.var = "beta", fill = 0) %>%
  comparison.cloud(colors = brewer.pal(7, "Set1"), max.words= 150, scale=c(3,0.2), 
           random.order = FALSE)

# words that have the greatest difference in beta weight between topics, can use when we are trying to determine the difference between two specific topics
beta_spread7.1.2 <- t1d_topics7 %>%
  mutate(topic = paste0("topic", topic)) %>%
  spread(topic, beta) %>%
  filter(topic1 > .001 | topic2 > .001) %>%
  mutate(log_ratio = log2(topic1 / topic2))

beta_spread7.1.2

#visualize this
beta_spread7.1.2 %>%
  mutate(abs_log_ratio = abs(log_ratio)) %>%
  arrange(desc(abs_log_ratio)) %>%
  filter(row_number() < 21) %>%
  arrange(desc(log_ratio)) %>%
  ggplot(aes(reorder(term,log_ratio), log_ratio)) +
  geom_col(fill = "#377F97", show.legend = FALSE) +
  coord_flip()

#per-document-per-topic probabilities, gamma
t1d_documents7 <- tidy(t1d_lda7, matrix = "gamma")
t1d_documents7

#check a tweet that is heavily in one topic
tidy(tweets_dtm) %>%
  filter(document == 	26428119) %>%
  arrange(desc(count)) 

```
